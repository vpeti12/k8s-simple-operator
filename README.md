# k8s-simple-operator
 A simple Kubernetes operator for deploying basic application (e.g. nginx,
 httpd) configurable using Kubernetes Custome Resource.

## Description
The purpose of this project is to demonstrate a simple [Kubernetes Operator](https://kubernetes.io/docs/concepts/extend-kubernetes/operator/)
generated by [Kubebuilder](https://github.com/kubernetes-sigs/kubebuilder).
The [Controller](https://kubernetes.io/docs/concepts/architecture/controller/)
logic handles the Reconciliation phase and aligns the Custom Resource changes.
The selected application is running in a Pod as par of the a Deployment with
the connecting Service and Ingress to forward the traffic.

## Getting Started
The operator can be run on any Kubernetes cluster, but there are some
prerequisites.

For local testing, you can use [KIND](https://sigs.k8s.io/kind).

### Prerequisites
The Kubernetes cluster should have the following components installed:

#### ingress-nginx
See the [install instructions](https://kubernetes.github.io/ingress-nginx/deploy/)
or simply run:
```sh
kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/main/deploy/static/provider/kind/deploy.yaml
```

### Configure using the Custrom Resource
There is a sample instance of the custom resource SimpleApp under
config/samples/. There are 3 parameters to customize the operator:

- image : the container image (and tag) of the application you would like run
- replicas : number of replicas of the deployed pods
- host : host where the application is accessible (ie. in the browser)

Example:
```yaml
  image: "nginx:latest"
  replicas: 1
  host: "helloworld.localdev.me"
```

### Running on the cluster
1. Install the CRDs into the cluster:

```sh
make install
```

2. Run your controller (this will run in the foreground, so switch to a new
terminal if you want to leave it running):

```sh
make run
```

3. Install Instances of Custom Resources:

```sh
kubectl apply -f config/samples/myapp_v1alpha1_simpleapp.yaml
```

### Deployment

1. Build and push your image to the location specified by `IMG`:

```sh
make docker-build docker-push IMG=<some-registry>/k8s-simple-operator:tag
```

2. Deploy the controller to the cluster with the image specified by `IMG`:

```sh
make deploy IMG=<some-registry>/k8s-simple-operator:tag
```

**NOTE:** UnDeploy the controller from the cluster:
```sh
make undeploy
```

### Uninstall CRDs
To delete the CRDs from the cluster:

```sh
make uninstall
```

## License

Copyright 2023 vpeti12.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
